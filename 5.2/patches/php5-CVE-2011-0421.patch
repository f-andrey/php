Subject: fix bug 53885 (ZipArchive segfault with FL_UNCHANGED on empty archive)
Origin: http://svn.php.net/viewvc/?view=revision&revision=307867
Bug: http://bugs.php.net/bug.php?id=53885

CVE-2011-421

Patch has been modified from upstream commit to remove edits to NEWS, to
reduce conflicts when applying.

Index: ext/zip/tests/bug53885.phpt
===================================================================
--- a/src/ext/zip/tests/bug53885.phpt	(revision 0)
+++ b/src/ext/zip/tests/bug53885.phpt	(revision 307867)
@@ -0,0 +1,19 @@
+--TEST--
+Bug #53885 (ZipArchive segfault with FL_UNCHANGED on empty archive)
+--SKIPIF--
+<?php
+if(!extension_loaded('zip')) die('skip');
+?>
+--FILE--
+<?php
+$fname = dirname(__FILE__)."/test53885.zip";
+if(file_exists($fname)) unlink($fname);
+touch($fname);
+$nx=new ZipArchive();
+$nx->open($fname);
+$nx->locateName("a",ZIPARCHIVE::FL_UNCHANGED);
+$nx->statName("a",ZIPARCHIVE::FL_UNCHANGED);
+?>
+==DONE==
+--EXPECTF--
+==DONE==
Index: ext/zip/lib/zip_name_locate.c
===================================================================
--- a/src/ext/zip/lib/zip_name_locate.c	(revision 307866)
+++ b/src/ext/zip/lib/zip_name_locate.c	(revision 307867)
@@ -60,6 +60,10 @@
 	return -1;
     }
 
+    if((flags & ZIP_FL_UNCHANGED)  && !za->cdir) {
+    	return -1;
+    }
+
     cmp = (flags & ZIP_FL_NOCASE) ? strcmpi : strcmp;
 
     n = (flags & ZIP_FL_UNCHANGED) ? za->cdir->nentry : za->nentry;
