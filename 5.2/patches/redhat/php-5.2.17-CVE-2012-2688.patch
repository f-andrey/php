diff -up php-5.2.17/main/streams/streams.c.CVE-2012-2688 php-5.2.17/main/streams/streams.c
--- php-5.2.17/src/main/streams/streams.c.CVE-2012-2688	2012-07-22 22:12:10.000000000 -0400
+++ php-5.2.17/src/main/streams/streams.c	2012-07-22 22:13:19.000000000 -0400
@@ -2095,8 +2095,8 @@ PHPAPI int _php_stream_scandir(char *dir
 	php_stream *stream;
 	php_stream_dirent sdp;
 	char **vector = NULL;
-	int vector_size = 0;
-	int nfiles = 0;
+	unsigned int vector_size = 0;
+	unsigned int nfiles = 0;
 
 	if (!namelist) {
 		return FAILURE;
@@ -2114,12 +2114,17 @@ PHPAPI int _php_stream_scandir(char *dir
 			} else {
 				vector_size *= 2;
 			}
-			vector = (char **) erealloc(vector, vector_size * sizeof(char *));
+			vector = (char **) safe_erealloc(vector, vector_size, sizeof(char *), 0);
 		}
 
 		vector[nfiles] = estrdup(sdp.d_name);
 
 		nfiles++;
+		if(vector_size < 10 || nfiles == 0) {
+			/* overflow */
+			efree(vector);
+			return FAILURE;
+		}
 	}
 	php_stream_closedir(stream);
 
