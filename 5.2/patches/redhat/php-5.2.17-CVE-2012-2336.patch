diff -up php-5.2.17/sapi/cgi/cgi_main.c.CVE-2012-2336 php-5.2.17/sapi/cgi/cgi_main.c
--- php-5.2.17/src/sapi/cgi/cgi_main.c.CVE-2012-2336	2012-08-24 11:41:35.000000000 +0700
+++ php-5.2.17/src/sapi/cgi/cgi_main.c	2012-08-24 11:40:11.000000000 +0700
@@ -1412,10 +1412,15 @@ int main(int argc, char *argv[])
 	}
 #endif
 
-	if(query_string = getenv("QUERY_STRING")) {
+		if((query_string = getenv("QUERY_STRING")) != NULL && strchr(query_string, '=') == NULL) {
+		/* we've got query string that has no = - apache CGI will pass it to command line */
+		unsigned char *p;
 		decoded_query_string = strdup(query_string);
 		php_url_decode(decoded_query_string, strlen(decoded_query_string));
-		if(*decoded_query_string == '-' && strchr(decoded_query_string, '=') == NULL) {
+		for (p = decoded_query_string; *p &&  *p <= ' '; p++) {
+		/* skip all leading spaces */
+		}
+		if(*p == '-') {
 			skip_getopt = 1;
 		}
 		free(decoded_query_string);
@@ -1675,7 +1680,7 @@ consult the installation file that came 
 #endif /* FASTCGI */
 
 	zend_first_try {
-		if (!cgi) while ((c = php_getopt(argc, argv, OPTIONS, &php_optarg, &php_optind, 1)) != -1) {
+		if (!cgi) while (!skip_getopt && (c = php_getopt(argc, argv, OPTIONS, &php_optarg, &php_optind, 1)) != -1) {
 			switch (c) {
 #if PHP_FASTCGI
 				case 'T':
