diff -up php-5.2.17/sapi/cgi/cgi_main.c.CVE-2012-1823 php-5.2.17/sapi/cgi/cgi_main.c
--- php-5.2.17/src/sapi/cgi/cgi_main.c.CVE-2012-1823	2012-05-03 20:52:54.000000000 -0400
+++ php-5.2.17/src/sapi/cgi/cgi_main.c	2012-05-03 20:56:33.000000000 -0400
@@ -62,6 +62,8 @@
 #include "php_main.h"
 #include "fopen_wrappers.h"
 #include "ext/standard/php_standard.h"
+#include "ext/standard/url.h"
+
 #ifdef PHP_WIN32
 #include <io.h>
 #include <fcntl.h>
@@ -1352,6 +1354,9 @@ int main(int argc, char *argv[])
 #ifndef PHP_WIN32
 	int status = 0;
 #endif
+	char *query_string;
+	char *decoded_query_string;
+	int skip_getopt = 0;
 #endif /* PHP_FASTCGI */
 
 #if 0 && defined(PHP_DEBUG)
@@ -1407,7 +1412,16 @@ int main(int argc, char *argv[])
 	}
 #endif
 
-	while ((c = php_getopt(argc, argv, OPTIONS, &php_optarg, &php_optind, 0)) != -1) {
+	if(query_string = getenv("QUERY_STRING")) {
+		decoded_query_string = strdup(query_string);
+		php_url_decode(decoded_query_string, strlen(decoded_query_string));
+		if(*decoded_query_string == '-' && strchr(decoded_query_string, '=') == NULL) {
+			skip_getopt = 1;
+		}
+		free(decoded_query_string);
+	}
+
+	while (!skip_getopt && (c = php_getopt(argc, argv, OPTIONS, &php_optarg, &php_optind, 0)) != -1) {
 		switch (c) {
 			case 'c':
 				if (cgi_sapi_module.php_ini_path_override) {
