Backport of:

From 97eff7eb57fc2320c267a949cffd622c38712484 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 22 May 2016 17:49:02 -0700
Subject: [PATCH] Fix bug #72241: get_icu_value_internal out-of-bounds read

---
 ext/intl/locale/locale_methods.c | 235 ++++++++++++++++++++-------------------
 ext/intl/tests/bug72241.phpt     |  14 +++
 2 files changed, 132 insertions(+), 117 deletions(-)
 create mode 100644 ext/intl/tests/bug72241.phpt

Index: php53-5.3.29/src/ext/intl/locale/locale_methods.c
===================================================================
--- php53-5.3.29.orig/src/ext/intl/locale/locale_methods.c	2016-10-06 17:23:02.564736949 +0300
+++ php53-5.3.29/src/ext/intl/locale/locale_methods.c	2016-10-06 17:23:02.560737075 +0300
@@ -326,6 +326,7 @@
 		if( U_FAILURE( status ) ) {
 			if( status == U_BUFFER_OVERFLOW_ERROR ) {
 				status = U_ZERO_ERROR;
+				buflen++; /* add space for \0 */
 				continue;
 			}
 
Index: php53-5.3.29/src/ext/intl/tests/bug72241.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php53-5.3.29/src/ext/intl/tests/bug72241.phpt	2016-10-06 17:23:02.560737075 +0300
@@ -0,0 +1,15 @@
+--TEST--
+Bug #72241: get_icu_value_internal out-of-bounds read
+--SKIPIF--
+<?php if( !extension_loaded( 'intl' ) ) print 'skip'; ?>
+--FILE--
+<?php
+$var1=str_repeat("A", 1000);
+$out = locale_get_primary_language($var1);
+echo strlen($out) . PHP_EOL;
+$result = unpack('H*', $out);
+echo $result[1] . PHP_EOL;
+--EXPECT--
+1000
+61616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161
+
