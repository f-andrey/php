From 6a7cc8ff85827fa9ac715b3a83c2d9147f33cd43 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 11 Sep 2016 21:19:29 -0700
Subject: [PATCH] Fix bug #73052 - Memory Corruption in During
 Deserialized-object Destruction

---
 Zend/zend_objects_API.c                    |  6 +--
 ext/standard/tests/serialize/bug73052.phpt | 18 +++++++++
 ext/standard/var_unserializer.c            | 61 +++++++++++++++---------------
 ext/standard/var_unserializer.re           |  1 +
 4 files changed, 53 insertions(+), 33 deletions(-)
 create mode 100644 ext/standard/tests/serialize/bug73052.phpt

Index: php5-5.3.10/src/ext/standard/tests/serialize/bug73052.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php5-5.3.10/src/ext/standard/tests/serialize/bug73052.phpt	2016-09-30 07:46:11.759140478 -0400
@@ -0,0 +1,18 @@
+--TEST--
+Bug #73052: Memory Corruption in During Deserialized-object Destruction
+--FILE--
+<?php
+
+class obj {
+    var $ryat;
+    public function __destruct() {
+        $this->ryat = null;
+    }
+}
+
+$poc = 'O:3:"obj":1:{';
+var_dump(unserialize($poc));
+?>
+--EXPECTF--
+Notice: unserialize(): Error at offset 13 of 13 bytes in %sbug73052.php on line %d
+bool(false)
Index: php5-5.3.10/src/ext/standard/var_unserializer.c
===================================================================
--- php5-5.3.10.orig/src/ext/standard/var_unserializer.c	2016-09-30 07:46:11.763140523 -0400
+++ php5-5.3.10/src/ext/standard/var_unserializer.c	2016-09-30 07:46:11.759140478 -0400
@@ -401,6 +401,7 @@
 	    /* We've got partially constructed object on our hands here. Wipe it */
 	    if(Z_TYPE_PP(rval) == IS_OBJECT) {
 	       zend_hash_clean(Z_OBJPROP_PP(rval));
+	       zend_object_store_ctor_failed(*rval TSRMLS_CC);
 	    }
 	    ZVAL_NULL(*rval);
 		return 0;
Index: php5-5.3.10/src/ext/standard/var_unserializer.re
===================================================================
--- php5-5.3.10.orig/src/ext/standard/var_unserializer.re	2016-09-30 07:46:11.763140523 -0400
+++ php5-5.3.10/src/ext/standard/var_unserializer.re	2016-09-30 07:46:11.759140478 -0400
@@ -407,6 +407,7 @@
 	    /* We've got partially constructed object on our hands here. Wipe it. */
 	    if(Z_TYPE_PP(rval) == IS_OBJECT) {
 	       zend_hash_clean(Z_OBJPROP_PP(rval));
+	       zend_object_store_ctor_failed(*rval TSRMLS_CC);
 	    }
 	    ZVAL_NULL(*rval);
 		return 0;
