Backport of:

From ecb7f58a069be0dec4a6131b6351a761f808f22e Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 11 Sep 2016 20:24:13 -0700
Subject: [PATCH] Fix bug #73029 - Missing type check when unserializing
 SplArray

---
 ext/spl/spl_array.c         | 10 ++++++----
 ext/spl/tests/bug73029.phpt | 16 ++++++++++++++++
 2 files changed, 22 insertions(+), 4 deletions(-)
 create mode 100644 ext/spl/tests/bug73029.phpt

Index: php53-5.3.29/src/ext/spl/spl_array.c
===================================================================
--- php53-5.3.29.orig/src/ext/spl/spl_array.c	2016-10-06 17:24:22.907185953 +0300
+++ php53-5.3.29/src/ext/spl/spl_array.c	2016-10-06 17:24:22.903186081 +0300
@@ -312,7 +312,7 @@
 	long index;
 	HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);
 
-	if (!offset) {
+	if (!offset || !ht) {
 		return &EG(uninitialized_zval_ptr);
 	}
 	
@@ -1799,7 +1799,9 @@
 		intern->ar_flags |= flags & SPL_ARRAY_CLONE_MASK;
 		zval_ptr_dtor(&intern->array);
 		ALLOC_INIT_ZVAL(intern->array);
-		if (!php_var_unserialize(&intern->array, &p, s + buf_len, var_hash_p TSRMLS_CC)) {
+		if (!php_var_unserialize(&intern->array, &p, s + buf_len, var_hash_p TSRMLS_CC)
+				|| (Z_TYPE_P(intern->array) != IS_ARRAY && Z_TYPE_P(intern->array) != IS_OBJECT)) {
+			zval_ptr_dtor(&intern->array);
 			goto outexcept;
 		}
 		var_push_dtor(var_hash_p, &intern->array);
