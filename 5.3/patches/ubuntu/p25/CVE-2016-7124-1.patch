From 448c9be157f4147e121f1a2a524536c75c9c6059 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Tue, 2 Aug 2016 01:08:42 -0700
Subject: [PATCH] Fix bug #72663 - destroy broken object when unserializing

---
 ext/standard/tests/strings/bug72663.phpt   | 26 +++++++++++
 ext/standard/tests/strings/bug72663_2.phpt | 17 ++++++++
 ext/standard/var_unserializer.c            | 70 ++++++++++++++++--------------
 ext/standard/var_unserializer.re           |  5 ++-
 4 files changed, 84 insertions(+), 34 deletions(-)
 create mode 100644 ext/standard/tests/strings/bug72663.phpt
 create mode 100644 ext/standard/tests/strings/bug72663_2.phpt

Index: php5-5.3.10/ext/standard/var_unserializer.c
===================================================================
--- php5-5.3.10.orig/src/ext/standard/var_unserializer.c	2016-09-30 07:45:16.022515589 -0400
+++ php5-5.3.10/src/ext/standard/var_unserializer.c	2016-09-30 07:45:16.018515545 -0400
@@ -398,6 +398,9 @@
 	zval fname;
 
 	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {
+	    /* We've got partially constructed object on our hands here. Wipe it */
+	    zend_hash_clean(Z_OBJPROP_PP(rval));
+	    ZVAL_NULL(*rval);
 		return 0;
 	}
 
Index: php5-5.3.10/ext/standard/var_unserializer.re
===================================================================
--- php5-5.3.10.orig/src/ext/standard/var_unserializer.re	2016-09-30 07:45:16.022515589 -0400
+++ php5-5.3.10/src/ext/standard/var_unserializer.re	2016-09-30 07:45:16.018515545 -0400
@@ -404,6 +404,9 @@
 	zval fname;
 
 	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {
+	    /* We've got partially constructed object on our hands here. Wipe it. */
+	    zend_hash_clean(Z_OBJPROP_PP(rval));
+	    ZVAL_NULL(*rval);
 		return 0;
 	}
 
