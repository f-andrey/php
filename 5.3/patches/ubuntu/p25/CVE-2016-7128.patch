From 6dbb1ee46b5f4725cc6519abf91e512a2a10dfed Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Mon, 8 Aug 2016 00:49:34 -0700
Subject: [PATCH] Fixed bug #72627: Memory Leakage In exif_process_IFD_in_TIFF

---
 ext/exif/exif.c              |   5 ++-
 ext/exif/tests/bug72627.phpt |  71 +++++++++++++++++++++++++++++++++++++++++++
 ext/exif/tests/bug72627.tiff | Bin 0 -> 1250 bytes
 3 files changed, 75 insertions(+), 1 deletion(-)
 create mode 100644 ext/exif/tests/bug72627.phpt
 create mode 100644 ext/exif/tests/bug72627.tiff

Index: php53-5.3.29/src/ext/exif/exif.c
===================================================================
--- php53-5.3.29.orig/src/ext/exif/exif.c	2016-10-06 17:24:03.810792427 +0300
+++ php53-5.3.29/src/ext/exif/exif.c	2016-10-06 17:24:03.807792523 +0300
@@ -3785,8 +3785,11 @@
 						fgot = php_stream_read(ImageInfo->infile, ImageInfo->Thumbnail.data, ImageInfo->Thumbnail.size);
 						if (fgot < ImageInfo->Thumbnail.size) {
 							EXIF_ERRLOG_THUMBEOF(ImageInfo)
+							efree(ImageInfo->Thumbnail.data);
+							ImageInfo->Thumbnail.data = NULL;
+						} else {
+							exif_thumbnail_build(ImageInfo TSRMLS_CC);
 						}
-						exif_thumbnail_build(ImageInfo TSRMLS_CC);
 					}
 #ifdef EXIF_DEBUG
 					exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_NOTICE, "Read next IFD (THUMBNAIL) done");
