From 64f42c73efc58e88671ad76b6b6bc8e2b62713e1 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Mon, 28 Mar 2016 01:22:37 -0700
Subject: [PATCH] Fixed bug #71906: AddressSanitizer: negative-size-param (-1)
 in mbfl_strcut

---
 ext/mbstring/libmbfl/mbfl/mbfilter.c | 34 +++++++++++++++++-----------------
 1 file changed, 17 insertions(+), 17 deletions(-)

Index: php5-5.3.10/ext/mbstring/libmbfl/mbfl/mbfilter.c
===================================================================
--- php5-5.3.10.orig/src/ext/mbstring/libmbfl/mbfl/mbfilter.c	2016-04-18 11:15:06.188547806 -0400
+++ php5-5.3.10/src/ext/mbstring/libmbfl/mbfl/mbfilter.c	2016-04-18 11:15:06.184547766 -0400
@@ -1381,7 +1381,7 @@
 		if (encoding->flag & (MBFL_ENCTYPE_WCS2BE | MBFL_ENCTYPE_WCS2LE)) {
 			from &= -2;
 
-			if (from + length >= string->len) {
+			if (length >= string->len - from) {
 				length = string->len - from;
 			}
 
@@ -1390,14 +1390,14 @@
 		} else if (encoding->flag & (MBFL_ENCTYPE_WCS4BE | MBFL_ENCTYPE_WCS4LE)) {
 			from &= -4;
 
-			if (from + length >= string->len) {
+			if (length >= string->len - from) {
 				length = string->len - from;
 			}
 
 			start = string->val + from;
 			end   = start + (length & -4);
 		} else if ((encoding->flag & MBFL_ENCTYPE_SBCS)) {
-			if (from + length >= string->len) {
+			if (length >= string->len - from) {
 				length = string->len - from;
 			}
 
@@ -1419,7 +1419,7 @@
 			start = p;
 
 			/* search end position */
-			if ((start - string->val) + length >= (int)string->len) {
+			if (length >= (int)string->len - (start - string->val)) {
 				end = string->val + string->len;
 			} else {
 				for (q = p + length; p < q; p += (m = mbtab[*p]));
