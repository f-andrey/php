From 1744be2d17befc69bf00033993f4081852a747d6 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 16 Aug 2015 17:16:15 -0700
Subject: [PATCH] Fix for bug #69782

---
 ext/xsl/xsltprocessor.c | 142 +++++++++++++++++++++++++-----------------------
 1 file changed, 73 insertions(+), 69 deletions(-)

Index: php5-5.3.10/ext/xsl/xsltprocessor.c
===================================================================
--- php5-5.3.10.orig/src/ext/xsl/xsltprocessor.c	2015-09-29 12:47:40.096026511 -0400
+++ php5-5.3.10/src/ext/xsl/xsltprocessor.c	2015-09-29 12:48:24.011830722 -0400
@@ -210,15 +210,17 @@
 			}
 		}
 	}
-	
+
 	if (error == 1) {
 		for (i = nargs - 1; i >= 0; i--) {
 			obj = valuePop(ctxt);
-			xmlXPathFreeObject(obj);
+			if (obj) {
+				xmlXPathFreeObject(obj);
+			}
 		}
 		return;
 	}
-		
+
 	fci.param_count = nargs - 1;
 	if (fci.param_count > 0) {
 		fci.params = safe_emalloc(fci.param_count, sizeof(zval**), 0);
@@ -290,9 +292,11 @@
 	fci.function_table = EG(function_table);
 	
 	obj = valuePop(ctxt);
-	if (obj->stringval == NULL) {
-		php_error_docref(NULL TSRMLS_CC, E_WARNING, "Handler name must be a string");
-		xmlXPathFreeObject(obj);
+	if (obj == NULL || obj->stringval == NULL) {
+		if (obj) {
+			php_error_docref(NULL TSRMLS_CC, E_WARNING, "Handler name must be a string");
+			xmlXPathFreeObject(obj);
+		}
 		if (fci.param_count > 0) {
 			for (i = 0; i < nargs - 1; i++) {
 				zval_ptr_dtor(&args[i]);
